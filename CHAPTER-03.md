# 第3章 ライブラリ・アーカイブの解析

### リスト 3.1 アーカイブ・ヘッダの定義

今回の環境では `/usr/include/ar.h` を参照した。
このファイルは `glibc-headers` パッケージが提供していた。

```
 /* Archive files start with the ARMAG identifying string.  Then follows a
    `struct ar_hdr', and as many bytes of member file data as its `ar_size'
    member indicates, for each member file.  */

 #define ARMAG   "!<arch>\n"     /* String that begins an archive file.  */
 #define SARMAG  8               /* Size of that string.  */

 #define ARFMAG  "`\n"           /* String in ar_fmag at end of each header.  */

 __BEGIN_DECLS

 struct ar_hdr
   {
     char ar_name[16];           /* Member file name, sometimes / terminated. */
     char ar_date[12];           /* File date, decimal seconds since Epoch.  */
     char ar_uid[6], ar_gid[6];  /* User and group IDs, in ASCII decimal.  */
     char ar_mode[8];            /* File mode, in ASCII octal.  */
     char ar_size[10];           /* File size, in ASCII decimal.  */
     char ar_fmag[2];            /* Always contains ARFMAG.  */
   };

 __END_DECLS
```

書籍の内容と同等のヘッダ定義内容となっていた。

### リスト 3.3 GNU binutils のアーカイブ

binutils の ar コマンドを使ってアーカイブを作ってみる。

```
$ echo "ABCD" > f12345678901234.txt
$ echo "ABCDE" > f123456789012345.txt
$ echo "ABCDEF" > f1234567890123456.txt
$ echo "ABCDEFG" > f12345678901234567.txt

$ /usr/bin/ar ruc gnuar.a f*.txt
```

内容を表示してみる。

```
$ cat gnuar.a
!<arch>
//                                              90        `
f12345678901234.txt/
f123456789012345.txt/
f1234567890123456.txt/
f12345678901234567.txt/
/0              1743934054  1000  1000  100644  5         `
ABCD

/21             1743934058  1000  1000  100644  6         `
ABCDE
/43             1743934061  1000  1000  100644  7         `
ABCDEF

/66             1743934065  1000  1000  100644  8         `
ABCDEFG
```

書籍の通り、最初のアーカイブエントリーとして `//` という名前でファイル名が格納されたエントリーが配置されている。
その後に `ar_hdr` とそれに続くファイル本体が格納されていることを確認できる。

hexdump結果：

```
$ /usr/bin/hexdump -C -v gnuar.a
00000000  21 3c 61 72 63 68 3e 0a  2f 2f 20 20 20 20 20 20  |!<arch>.//      |
00000010  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000020  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000030  20 20 20 20 20 20 20 20  39 30 20 20 20 20 20 20  |        90      |
00000040  20 20 60 0a 66 31 32 33  34 35 36 37 38 39 30 31  |  `.f12345678901|
00000050  32 33 34 2e 74 78 74 2f  0a 66 31 32 33 34 35 36  |234.txt/.f123456|
00000060  37 38 39 30 31 32 33 34  35 2e 74 78 74 2f 0a 66  |789012345.txt/.f|
00000070  31 32 33 34 35 36 37 38  39 30 31 32 33 34 35 36  |1234567890123456|
00000080  2e 74 78 74 2f 0a 66 31  32 33 34 35 36 37 38 39  |.txt/.f123456789|
00000090  30 31 32 33 34 35 36 37  2e 74 78 74 2f 0a 2f 30  |01234567.txt/./0|
000000a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 31 37  |              17|
000000b0  34 33 39 33 34 30 35 34  20 20 31 30 30 30 20 20  |43934054  1000  |
000000c0  31 30 30 30 20 20 31 30  30 36 34 34 20 20 35 20  |1000  100644  5 |
000000d0  20 20 20 20 20 20 20 20  60 0a 41 42 43 44 0a 0a  |        `.ABCD..|
000000e0  2f 32 31 20 20 20 20 20  20 20 20 20 20 20 20 20  |/21             |
000000f0  31 37 34 33 39 33 34 30  35 38 20 20 31 30 30 30  |1743934058  1000|
00000100  20 20 31 30 30 30 20 20  31 30 30 36 34 34 20 20  |  1000  100644  |
00000110  36 20 20 20 20 20 20 20  20 20 60 0a 41 42 43 44  |6         `.ABCD|
00000120  45 0a 2f 34 33 20 20 20  20 20 20 20 20 20 20 20  |E./43           |
00000130  20 20 31 37 34 33 39 33  34 30 36 31 20 20 31 30  |  1743934061  10|
00000140  30 30 20 20 31 30 30 30  20 20 31 30 30 36 34 34  |00  1000  100644|
00000150  20 20 37 20 20 20 20 20  20 20 20 20 60 0a 41 42  |  7         `.AB|
00000160  43 44 45 46 0a 0a 2f 36  36 20 20 20 20 20 20 20  |CDEF../66       |
00000170  20 20 20 20 20 20 31 37  34 33 39 33 34 30 36 35  |      1743934065|
00000180  20 20 31 30 30 30 20 20  31 30 30 30 20 20 31 30  |  1000  1000  10|
00000190  30 36 34 34 20 20 38 20  20 20 20 20 20 20 20 20  |0644  8         |
000001a0  60 0a 41 42 43 44 45 46  47 0a                    |`.ABCDEFG.|
000001aa
```

- ヘッダーや本体データが 0x0a (LF) 区切りで格納されていることを確認できる。
- ファイル名など余白は 0x20 で padding されていることを確認できる。
- sizeが奇数の場合、LFが1つ余分に追加されて align 調整されていることを確認できる。

### リスト 3.4 アーカイブ・ファイルのダンプ

- [readname.c](CHAPTER-03/readname.c)
  - 書籍からの変更点はなし

コンパイルと実行:

```
$ gcc readname.c -Wall -o readname
( printf() で warning が表示されるがスルー )

$ ./readname gnuar.a
string table found.
f12345678901234.txt     5
f123456789012345.txt    6
f1234567890123456.txt   7
f12345678901234567.txt  8
```

書籍と同様にアーカイブファイル内のファイル名とサイズを表示することができた。

